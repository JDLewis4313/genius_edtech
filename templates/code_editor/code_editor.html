{% extends 'base.html' %}
{% load static %}

{% block title %}Code Editor - GeNiUS EdTech{% endblock %}

{% block extra_css %}
<style>
    .editor-container {
        background: var(--bg-primary);
        border-radius: 15px;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }
    
    .language-tab {
        background: rgba(26, 31, 58, 0.8);
        border: 2px solid var(--ni-chrome);
        color: var(--text-secondary);
        padding: 10px 20px;
        border-radius: 25px;
        margin: 0 5px;
        transition: all 0.3s ease;
        font-weight: 500;
    }
    
    .language-tab:hover,
    .language-tab.active {
        background: var(--primary-gradient);
        color: var(--bg-primary);
        border-color: var(--u-green);
        transform: translateY(-2px);
    }
    
    .output-panel {
        background: var(--bg-primary);
        border: 2px solid var(--u-green);
        border-radius: 15px;
        font-family: 'JetBrains Mono', monospace;
        color: var(--u-green);
        min-height: 300px;
        position: relative;
        overflow: hidden;
        padding: 1rem;
    }
    
    .output-panel::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 2px;
        background: var(--primary-gradient);
        animation: scanline 2s ease-in-out infinite;
    }
    
    @keyframes scanline {
        0%, 100% { transform: translateX(-100%); }
        50% { transform: translateX(100%); }
    }
    
    .action-btn {
        padding: 12px 25px;
        border-radius: 25px;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .btn-run {
        background: var(--primary-gradient);
        color: var(--bg-primary);
    }
    
    .btn-run:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 184, 148, 0.3);
    }
    
    .btn-clear {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-secondary);
        border: 2px solid var(--text-muted);
    }
    
    .btn-clear:hover {
        background: rgba(255, 255, 255, 0.2);
        color: var(--text-primary);
    }
    
    .btn-save {
        background: rgba(255, 255, 255, 0.1);
        color: var(--text-secondary);
        border: 2px solid var(--text-muted);
    }
    
    .btn-save:hover {
        background: rgba(255, 255, 255, 0.2);
        color: var(--text-primary);
    }
    
    .code-editor {
        width: 100%;
        height: 400px;
        border-radius: 0 0 15px 15px;
    }
    
    .template-card {
        height: 100%;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
    }
    
    .template-title {
        font-size: 1.4rem;
        font-weight: 600;
        margin-bottom: 10px;
        color: var(--text-primary);
    }
    
    .template-description {
        color: var(--text-secondary);
        margin-bottom: 15px;
        font-size: 0.95rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="text-center mb-5 fade-in">
        <h1 class="text-gradient mb-3">
            <i class="fas fa-code"></i> GeNiUS Code Lab
        </h1>
        <p style="color: var(--text-secondary);">Write, run, and experiment with chemistry-focused code</p>
    </div>
    
    <!-- Chemistry Code Templates -->
    <div class="row mb-5">
        <div class="col-12">
            <h3 class="mb-4" style="color: var(--text-primary);">
                <i class="fas fa-flask"></i> Chemistry Code Templates
            </h3>
        </div>
        <div class="col-lg-4 col-md-6">
            <div class="card template-card" onclick="loadTemplate('molecular_weight')">
                <div class="card-body">
                    <h4 class="template-title">Molecular Weight Calculator</h4>
                    <p class="template-description">Calculate molecular weights using atomic masses</p>
                    <span class="badge bg-primary">Python</span>
                </div>
            </div>
        </div>
        <div class="col-lg-4 col-md-6">
            <div class="card template-card" onclick="loadTemplate('equation_parser')">
                <div class="card-body">
                    <h4 class="template-title">Chemical Equation Parser</h4>
                    <p class="template-description">Parse and analyze chemical equations</p>
                    <span class="badge bg-warning">JavaScript</span>
                </div>
            </div>
        </div>
        <div class="col-lg-4 col-md-6">
            <div class="card template-card" onclick="loadTemplate('periodic_table')">
                <div class="card-body">
                    <h4 class="template-title">Periodic Table Queries</h4>
                    <p class="template-description">Query chemical elements database</p>
                    <span class="badge bg-info">SQL</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Code Editor -->
    <div class="row mb-4">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4><i class="fas fa-edit"></i> Code Editor</h4>
                        <div>
                            <button class="language-tab active" onclick="switchLanguage('python')">Python</button>
                            <button class="language-tab" onclick="switchLanguage('javascript')">JavaScript</button>
                            <button class="language-tab" onclick="switchLanguage('sql')">SQL</button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <!-- Editor container, default text begin -->

                    <!-- Editor container, default text end -->

                    <div id="editor" class="code-editor"></div>
                </div>
                <div class="card-footer">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <span class="text-muted me-3">Language: <span id="language-indicator" class="text-u">Python</span></span>
                            <span class="text-muted">Lines: <span id="line-count">15</span></span>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="action-btn btn-run" onclick="runCode()">
                                <i class="fas fa-play"></i> Run Code
                            </button>
                            <button class="action-btn btn-clear" onclick="clearEditor()">
                                <i class="fas fa-trash"></i> Clear
                            </button>
                            <button class="action-btn btn-save" onclick="saveCode()">
                                <i class="fas fa-save"></i> Save
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Output Panel -->
    <div class="row">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header">
                    <h4><i class="fas fa-terminal"></i> Output</h4>
                </div>
                <div class="card-body">
                    <div class="output-panel" id="output">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-info-circle me-2"></i>
                            <span>Ready to execute your chemistry code!</span>
                        </div>
                        <div class="mt-4" style="color: var(--text-secondary);">
                            <strong>Features:</strong>
                            <ul class="mt-2">
                                <li>Fully editable code editor</li>
                                <li>Multiple language support</li>
                                <li>Chemistry code templates</li>
                                <li>Save/Load functionality</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Help Section -->
    <div class="row mt-4">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header">
                    <h4><i class="fas fa-question-circle"></i> Help & Resources</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Chemistry Code Examples</h5>
                            <ul>
                                <li>Molecular weight calculation</li>
                                <li>Balancing chemical equations</li>
                                <li>Stoichiometry calculations</li>
                                <li>pH and acid-base calculations</li>
                                <li>Thermodynamics simulations</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h5>Educational Purpose</h5>
                            <p>
                                This code editor is designed to help you learn chemistry concepts through coding. 
                                By writing and executing code, you can gain a deeper understanding of chemical principles 
                                and develop computational thinking skills.
                            </p>
                            <a href="{% url 'quiz:tutorials' %}" class="btn btn-primary mt-2">
                                <i class="fas fa-book-open me-2"></i> View Tutorials
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.43.0/min/vs/loader.min.js"></script>
<script>
    // CSRF token helper (required for Django POST)
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    window.csrfToken = getCookie('csrftoken');

    let editor;
    let currentLanguage = 'python';

    // Default code for the editor
    const defaultCode = {
        python: `# Welcome to GeNiUS Code Lab! ðŸ§ªðŸ”¬
# Calculate molecular weight of water (H2O)

def calculate_molecular_weight():
    # Atomic masses (g/mol)
    H = 1.008  # Hydrogen
    O = 15.999 # Oxygen

    # Water molecule: H2O
    water_mw = (2 * H) + O
    print(f'Molecular weight of H2O: {water_mw:.3f} g/mol')

    # Calculate moles in 18g of water
    mass = 18.0  # grams
    moles = mass / water_mw
    print(f'Moles in {mass}g of water: {moles:.3f} mol')

    return water_mw

# Run the calculation
calculate_molecular_weight()`,
        javascript: `// Welcome to GeNiUS Code Lab! ðŸ§ªðŸ”¬
// Calculate molecular weight of water (H2O) in JavaScript

const H = 1.008; // Hydrogen
const O = 15.999; // Oxygen

const water_mw = (2 * H) + O;
console.log("Molecular weight of H2O: " + water_mw.toFixed(3) + " g/mol");

const mass = 18.0; // grams
const moles = mass / water_mw;
console.log("Moles in 18g of water: " + moles.toFixed(3) + " mol");`,
        sql: `-- Welcome to GeNiUS Code Lab! ðŸ§ªðŸ”¬
-- Query to select all elements from a periodic table database

SELECT * FROM elements WHERE symbol = 'H2O';`
    };

    require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.43.0/min/vs' }});
    require(['vs/editor/editor.main'], function() {
        editor = monaco.editor.create(document.getElementById('editor'), {
            value: defaultCode.python,
            language: 'python',
            theme: 'vs-dark',
            automaticLayout: true,
            minimap: { enabled: true },
            scrollBeyondLastLine: false,
            fontSize: 14,
            fontFamily: "'JetBrains Mono', monospace",
            tabSize: 4,
            insertSpaces: true,
            wordWrap: 'on'
        });

        // Update line count on editor change
        editor.onDidChangeModelContent(function() {
            updateLineCount();
        });

        // Initial line count update
        updateLineCount();
    });

    function updateLineCount() {
        if (editor) {
            const lineCount = editor.getModel().getLineCount();
            document.getElementById('line-count').textContent = lineCount;
        }
    }

    function switchLanguage(event, language) {
        currentLanguage = language;
        monaco.editor.setModelLanguage(editor.getModel(), language);

        // Set default code for language
        if (defaultCode[language]) {
            editor.setValue(defaultCode[language]);
        } else {
            editor.setValue('');
        }

        // Update language indicator
        document.getElementById('language-indicator').textContent = language.charAt(0).toUpperCase() + language.slice(1);

        // Update active tab
        document.querySelectorAll('.language-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        event.target.classList.add('active');

        updateLineCount();
    }

    // Dummy loadTemplate (implement as needed!)
    function loadTemplate(templateName) {
        alert('Template loading coming soon!');
    }

    function runCode() {
        const code = editor.getValue();
        const outputElement = document.getElementById('output');
        outputElement.innerHTML = `
            <div style="color: var(--u-green); margin-bottom: 10px;">
                <i class="fas fa-play-circle"></i> Executing ${currentLanguage} code...
            </div>
        `;
        fetch("{% url 'code_editor:run_code' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": window.csrfToken
            },
            body: JSON.stringify({
                code: code,
                language: currentLanguage
            }),
        })
        .then(res => res.json())
        .then(data => {
            outputElement.innerHTML += `
                <div style="color: var(--text-primary); font-family: 'JetBrains Mono', monospace; white-space: pre-line;">
${data.output || '(No output)'}
                </div>
            `;
        })
        .catch(err => {
            outputElement.innerHTML += `
                <div style="color: red">Error running code: ${err}</div>
            `;
        });
    }

    function clearEditor() {
        if (confirm("Are you sure you want to clear the editor? All code will be lost.")) {
            editor.setValue("");
            document.getElementById('output').innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-info-circle me-2"></i>
                    <span>Ready to execute your chemistry code!</span>
                </div>
            `;
        }
    }

    function saveCode() {
        const code = editor.getValue();
        const blob = new Blob([code], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `chemistry_code.${currentLanguage === 'javascript' ? 'js' : currentLanguage}`;
        a.click();
        URL.revokeObjectURL(url);
    }
</script>
{% endblock %}