
{% extends "core/base.html" %}
{% load static %}
{% block title %}Interactive Quiz System - GeNiUS EdTech{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="text-center mb-5 fade-in">
        <h1 class="text-gradient mb-3">
            <i class="fas fa-question-circle"></i> Interactive Quiz System
        </h1>
        <p style="color: var(--text-secondary);">Test your knowledge of chemistry concepts with adaptive quizzes</p>
    </div>
    
    <!-- Module Selection -->
    <div class="row mb-5">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header">
                    <h4><i class="fas fa-book-open"></i> Select a Module</h4>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        {% for module in modules %}
                        <div class="col-md-4 mb-4">
                            <div class="card feature-card module-card" data-module-id="{{ module.id }}">
                                <div class="card-body">
                                    <h5 class="card-title">
                                        <i class="fas fa-atom me-2" style="color: var(--u-green);"></i> {{ module.title }}
                                    </h5>
                                    <p class="card-text">{{ module.description }}</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span><i class="fas fa-list-ul me-1"></i> {{ module.topics.count }} Topics</span>
                                        <button class="btn btn-sm btn-primary module-expand-btn">View Topics</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Topic Selection (initially hidden) -->
    <div id="topics-container" class="row mb-5" style="display: none;">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4><i class="fas fa-list-ul"></i> <span id="module-title">Module Topics</span></h4>
                    <button id="back-to-modules" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-arrow-left"></i> Back to Modules
                    </button>
                </div>
                <div class="card-body">
                    <div id="topics-list" class="row g-4">
                        <!-- Topics will be populated dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quiz Interface (initially hidden) -->
    <div id="quiz-interface" style="display: none;">
        <div class="row">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4 id="quiz-topic-title"><i class="fas fa-atom"></i> Quiz Topic</h4>
                            <div>
                                <span class="badge bg-primary me-2">Question <span id="current-question">1</span>/<span id="total-questions">15</span></span>
                                <span class="badge bg-success">Score: <span id="score">0</span></span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-4">
                        {% csrf_token %}
                        <div id="question-container">
                            <h5 id="question-text" class="mb-4">Question will appear here</h5>
                            <div id="options-container" class="mb-3">
                                <!-- Options will be populated dynamically -->
                            </div>
                            <div class="mt-4">
                                <button id="submit-answer" class="btn btn-primary">
                                    <i class="fas fa-paper-plane me-2"></i> Submit Answer
                                </button>
                            </div>
                        </div>
                        
                        <div id="feedback-container" style="display: none;">
                            <div class="alert" id="feedback-alert">
                                <h5 id="feedback-title" class="mb-2"></h5>
                                <p id="feedback-text"></p>
                                <hr>
                                <h6>Explanation:</h6>
                                <p id="explanation-text"></p>
                            </div>
                            
                            <button id="next-question" class="btn btn-primary">
                                <i class="fas fa-arrow-right me-2"></i> Next Question
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-info-circle"></i> Quiz Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <h6 class="text-u">Topic</h6>
                            <p id="quiz-info-topic">Topic Name</p>
                        </div>
                        <div class="mb-3">
                            <h6 class="text-u">Module</h6>
                            <p id="quiz-info-module">Module Name</p>
                        </div>
                        <div class="mb-3">
                            <h6 class="text-s">Difficulty</h6>
                            <p id="quiz-info-difficulty">Difficulty Level</p>
                        </div>
                        <div class="mb-3">
                            <h6 class="text-er">Time Elapsed</h6>
                            <p id="time-elapsed">00:00</p>
                        </div>
                        <div class="progress mb-3">
                            <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%; background: var(--primary-gradient);" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h6><i class="fas fa-cogs"></i> Quiz Controls</h6>
                    </div>
                    <div class="card-body">
                        <button id="quit-quiz" class="btn btn-danger btn-sm mb-2 w-100">
                            <i class="fas fa-times-circle"></i> Quit Quiz
                        </button>
                        <button class="btn btn-secondary btn-sm w-100">
                            <i class="fas fa-flag"></i> Report Issue
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Results Page (initially hidden) -->
    <div id="results-page" style="display: none;">
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="card">
                    <div class="card-header text-center">
                        <h4><i class="fas fa-trophy"></i> Quiz Results</h4>
                    </div>
                    <div class="card-body text-center p-5">
                        <div class="mb-4">
                            <div id="results-circle" style="width: 150px; height: 150px; margin: 0 auto; background: conic-gradient(var(--u-green) 0% 80%, var(--bg-secondary) 80% 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; font-weight: bold; color: var(--text-primary);">
                                80%
                            </div>
                        </div>
                        
                        <h3 class="mb-3" id="results-message">Great Job!</h3>
                        <p class="lead mb-4">You scored <span id="final-score">12</span> out of <span id="final-total">15</span> questions correctly.</p>
                        
                        <div class="row mb-4">
                            <div class="col-sm-4">
                                <div class="bg-glass p-3 rounded-3">
                                    <h4 id="correct-answers" class="text-u mb-1">12</h4>
                                    <p class="small mb-0">Correct Answers</p>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="bg-glass p-3 rounded-3">
                                    <h4 id="incorrect-answers" class="text-er mb-1">3</h4>
                                    <p class="small mb-0">Incorrect Answers</p>
                                </div>
                            </div>
                            <div class="col-sm-4">
                                <div class="bg-glass p-3 rounded-3">
                                    <h4 id="time-taken" class="text-s mb-1">05:32</h4>
                                    <p class="small mb-0">Time Taken</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-3 justify-content-center">
                            <button id="restart-quiz" class="btn btn-primary">
                                <i class="fas fa-redo me-2"></i> Retake Quiz
                            </button>
                            <a href="{% url 'tutorials:tutorial_list' %}" class="btn btn-outline-primary">
                                <i class="fas fa-book me-2"></i> More Tutorials
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Study Guide Section -->
    <div class="row mt-5">
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header">
                    <h4><i class="fas fa-book"></i> Study Guides</h4>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        {% for module in modules|slice:":3" %}
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">
                                        <i class="fas fa-atom me-2" style="color: var(--u-green);"></i> {{ module.title }} Guide
                                    </h5>
                                    <p class="card-text">Comprehensive review of {{ module.title|lower }} concepts.</p>
                                    <a href="#" class="btn btn-outline-primary btn-sm">View Guide</a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let timer;
    let seconds = 0;
    let quizData = null;
    let currentQuestionIndex = 0;
    let userAnswers = [];
    let currentTopicId = null;
    
    // Add click handlers to module cards
    document.querySelectorAll('.module-expand-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.stopPropagation();
            const moduleCard = this.closest('.module-card');
            const moduleId = moduleCard.dataset.moduleId;
            showTopics(moduleId);
        });
    });
    
    // Module card click
    document.querySelectorAll('.module-card').forEach(card => {
        card.addEventListener('click', function() {
            const moduleId = this.dataset.moduleId;
            showTopics(moduleId);
        });
    });
    
    // Back to modules button
    document.getElementById('back-to-modules').addEventListener('click', function() {
        document.getElementById('topics-container').style.display = 'none';
    });
    
    // Function to show topics for a module
    function showTopics(moduleId) {
        // Fetch topics for this module
        fetch(`/quiz/api/topics/${moduleId}/`)
            .then(response => response.json())
            .then(data => {
                // Update module title
                document.getElementById('module-title').textContent = data.module.title + ' Topics';
                
                // Clear existing topics
                const topicsList = document.getElementById('topics-list');
                topicsList.innerHTML = '';
                
                // Add topics
                data.topics.forEach(topic => {
                    const topicCard = document.createElement('div');
                    topicCard.className = 'col-md-4 mb-3';
                    topicCard.innerHTML = `
                        <div class="card feature-card quiz-topic" data-topic-id="${topic.id}">
                            <div class="card-body">
                                <h5 class="card-title">
                                    <i class="fas fa-list-ul me-2" style="color: var(--u-green);"></i> ${topic.title}
                                </h5>
                                <p class="card-text">${topic.description || 'Test your knowledge on this topic.'}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="badge bg-${getDifficultyColor(topic.difficulty)}">
                                        ${capitalizeFirstLetter(topic.difficulty)}
                                    </span>
                                    <span><i class="fas fa-question-circle me-1"></i> ${topic.question_count} Questions</span>
                                </div>
                            </div>
                        </div>
                    `;
                    topicsList.appendChild(topicCard);
                    
                    // THIS IS THE FIXED PART - selecting the element and adding listener after DOM insertion
                    const quizTopicElement = topicCard.querySelector('.quiz-topic');
                    if (quizTopicElement) {
                        quizTopicElement.addEventListener('click', function() {
                            startQuiz(topic.id);
                        });
                    }
                });
                
                // Show topics container
                document.getElementById('topics-container').style.display = 'block';
                document.getElementById('topics-container').scrollIntoView({ behavior: 'smooth' });
            })
            .catch(error => {
                console.error('Error loading topics:', error);
                alert('Failed to load topics. Please try again.');
            });
    }
    
    // Start quiz function
    function startQuiz(topicId) {
        currentTopicId = topicId;
        
        // Fetch questions from the API
        fetch(`/quiz/api/questions/${topicId}/`)
            .then(response => response.json())
            .then(data => {
                // Store quiz data
                quizData = data;
                currentQuestionIndex = 0;
                userAnswers = new Array(data.questions.length).fill(null);
                
                // Update quiz info
                document.getElementById('quiz-topic-title').innerHTML = 
                    `<i class="fas fa-list-ul"></i> ${data.topic.title} Quiz`;
                document.getElementById('quiz-info-topic').innerText = data.topic.title;
                document.getElementById('quiz-info-module').innerText = data.topic.module;
                document.getElementById('quiz-info-difficulty').innerText = 
                    capitalizeFirstLetter(data.topic.difficulty);
                
                // Reset quiz state
                document.getElementById('current-question').innerText = '1';
                document.getElementById('total-questions').innerText = data.questions.length;
                document.getElementById('score').innerText = '0';
                document.getElementById('progress-bar').style.width = '0%';
                
                // Load first question
                loadQuestion(0);
                
                // Show quiz interface, hide other sections
                document.getElementById('topics-container').style.display = 'none';
                document.getElementById('quiz-interface').style.display = 'block';
                document.getElementById('results-page').style.display = 'none';
                
                // Start timer
                seconds = 0;
                if (timer) clearInterval(timer);
                timer = setInterval(updateTimer, 1000);
                
                // Scroll to quiz interface
                document.getElementById('quiz-interface').scrollIntoView({ behavior: 'smooth' });
            })
            .catch(error => {
                console.error('Error loading quiz questions:', error);
                alert('Failed to load quiz questions. Please try again.');
            });
    }
    
    // Function to load a question
    function loadQuestion(index) {
        const question = quizData.questions[index];
        
        // Update the current question index
        document.getElementById('current-question').innerText = index + 1;
        
        // Update progress bar
        const progress = ((index + 1) / quizData.questions.length) * 100;
        document.getElementById('progress-bar').style.width = `${progress}%`;
        
        // Set question text
        document.getElementById('question-text').innerHTML = question.text;
        
        // Generate options HTML
        const optionsContainer = document.getElementById('options-container');
        optionsContainer.innerHTML = '';
        
        question.choices.forEach((choice, i) => {
            const optionDiv = document.createElement('div');
            optionDiv.className = 'form-check';
            optionDiv.innerHTML = `
                <input class="form-check-input" type="radio" name="answer" 
                    id="option${i}" value="${choice.id}">
                <label class="form-check-label" for="option${i}">${choice.text}</label>
            `;
            optionsContainer.appendChild(optionDiv);
        });
        
        // Show question container, hide feedback container
        document.getElementById('question-container').style.display = 'block';
        document.getElementById('feedback-container').style.display = 'none';
    }
    
    // Update timer function
    function updateTimer() {
        seconds++;
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = seconds % 60;
        document.getElementById('time-elapsed').innerText = `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
    }
    
    // Handle submit answer
    document.getElementById('submit-answer').addEventListener('click', function() {
        // Get selected answer
        const selectedOption = document.querySelector('input[name="answer"]:checked');
        
        if (!selectedOption) {
            alert('Please select an answer');
            return;
        }
        
        const currentQuestion = quizData.questions[currentQuestionIndex];
        const selectedChoiceId = parseInt(selectedOption.value);
        
        // Find if the selected choice is correct
        const selectedChoice = currentQuestion.choices.find(choice => choice.id === selectedChoiceId);
        const isCorrect = selectedChoice.is_correct;
        
        // Save user's answer
        userAnswers[currentQuestionIndex] = {
            questionId: currentQuestion.id,
            choiceId: selectedChoiceId,
            isCorrect: isCorrect
        };
        
        // Update score if correct
        if (isCorrect) {
            const currentScore = parseInt(document.getElementById('score').innerText);
            document.getElementById('score').innerText = currentScore + 1;
        }
        
        // Show feedback
        document.getElementById('question-container').style.display = 'none';
        document.getElementById('feedback-container').style.display = 'block';
        
        // Set feedback content
        const feedbackAlert = document.getElementById('feedback-alert');
        const feedbackTitle = document.getElementById('feedback-title');
        const feedbackText = document.getElementById('feedback-text');
        const explanationText = document.getElementById('explanation-text');
        
        if (isCorrect) {
            feedbackAlert.className = 'alert alert-success';
            feedbackTitle.innerText = 'Correct!';
            feedbackText.innerText = 'Great job! You selected the right answer.';
        } else {
            feedbackAlert.className = 'alert alert-danger';
            feedbackTitle.innerText = 'Incorrect';
            
            // Find the correct answer
            const correctChoice = currentQuestion.choices.find(choice => choice.is_correct);
            feedbackText.innerText = `The correct answer is "${correctChoice.text}".`;
        }
        
        explanationText.innerHTML = currentQuestion.explanation || 'No explanation provided.';
    });
    
    // Handle next question
    document.getElementById('next-question').addEventListener('click', function() {
        currentQuestionIndex++;
        
        if (currentQuestionIndex < quizData.questions.length) {
            // Load next question
            loadQuestion(currentQuestionIndex);
        } else {
            // End of quiz - show results
            showResults();
        }
    });
    
    // Show results function
    function showResults() {
        // Stop timer
        clearInterval(timer);
        
        // Calculate final score
        const score = userAnswers.filter(answer => answer && answer.isCorrect).length;
        const total = quizData.questions.length;
        const percentage = Math.round((score / total) * 100);
        
        // Update results display
        document.getElementById('final-score').innerText = score;
        document.getElementById('final-total').innerText = total;
        document.getElementById('correct-answers').innerText = score;
        document.getElementById('incorrect-answers').innerText = total - score;
        
        // Format time taken
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = seconds % 60;
        document.getElementById('time-taken').innerText = 
            `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        
        // Update progress circle
        document.getElementById('results-circle').style.background = 
            `conic-gradient(var(--u-green) 0% ${percentage}%, var(--bg-secondary) ${percentage}% 100%)`;
        document.getElementById('results-circle').innerText = `${percentage}%`;
        
        // Set result message based on score
        const messageEl = document.getElementById('results-message');
        if (percentage >= 80) {
            messageEl.innerText = 'Excellent Job!';
        } else if (percentage >= 60) {
            messageEl.innerText = 'Good Work!';
        } else if (percentage >= 40) {
            messageEl.innerText = 'Nice Effort!';
        } else {
            messageEl.innerText = 'Keep Practicing!';
        }
        
        // Save score if user is logged in
        if (currentTopicId) {
            submitScore(currentTopicId, score, total);
        }
        
        // Hide quiz interface, show results
        document.getElementById('quiz-interface').style.display = 'none';
        document.getElementById('results-page').style.display = 'block';
        
        // Scroll to results
        document.getElementById('results-page').scrollIntoView({ behavior: 'smooth' });
    }
    
    // Function to submit score to server
    function submitScore(topicId, score, totalQuestions) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // Create form data
        const formData = new FormData();
        formData.append('topic_id', topicId);
        formData.append('score', score);
        formData.append('total', totalQuestions);
        
        // Submit via fetch
        fetch('/quiz/submit-score/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            console.log('Score saved successfully:', data);
        })
        .catch(error => {
            console.error('Error saving score:', error);
        });
    }
    
    // Handle quit quiz
    document.getElementById('quit-quiz').addEventListener('click', function() {
        if (confirm('Are you sure you want to quit this quiz? Your progress will be lost.')) {
            // Stop timer
            clearInterval(timer);
            
            // Hide quiz interface
            document.getElementById('quiz-interface').style.display = 'none';
            
            // Scroll back to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    });
    
    // Handle restart quiz
    document.getElementById('restart-quiz').addEventListener('click', function() {
        if (currentTopicId) {
            startQuiz(currentTopicId);
        }
    });
    
    // Helper function to convert to title case
    function capitalizeFirstLetter(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
    }
    
    // Helper function to get badge color for difficulty
    function getDifficultyColor(difficulty) {
        switch(difficulty) {
            case 'easy':
                return 'success';
            case 'medium':
                return 'warning';
            case 'hard':
                return 'danger';
            default:
                return 'primary';
        }
    }
});
</script>
{% endblock %}


